<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>êµì‚¬ìš© í™”ë©´</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, setDoc, collection, onSnapshot, updateDoc } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ğŸ”‘ Firebase ì„¤ì • (ë³¸ì¸ í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ êµì²´)
    const firebaseConfig = {
        apiKey: "AIzaSyD6EWEz8M1XtS9RBZwVamu2fpRrqHMdG0M",
        authDomain: "click-6bcfe.firebaseapp.com",
        projectId: "click-6bcfe",
        storageBucket: "click-6bcfe.firebasestorage.app",
        messagingSenderId: "1017935345719",
        appId: "1:1017935345719:web:f08d5041bc4e4de34aa7b2",
        measurementId: "G-R7MS8WD44W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentSessionId = null;

    async function newSession() {
      // ë¬´ì‘ìœ„ ì„¸ì…˜ ID ìƒì„±
      currentSessionId = Math.random().toString(36).substring(2, 8);

      // Firestoreì— ì„¸ì…˜ ë¬¸ì„œ ìƒì„±
      await setDoc(doc(db, "sessions", currentSessionId), {
        status: "waiting",
        createdAt: Date.now()
      });

      // í•™ìƒ ì ‘ì†ìš© URL
      const studentUrl = 
        `${window.location.origin}${window.location.pathname.replace("index.html","")}student.html?session=${currentSessionId}`;

      // QRì½”ë“œ ìƒì„±
      const qrCanvas = document.getElementById("qrcode");
      qrCanvas.innerHTML = "";
      QRCode.toCanvas(qrCanvas, studentUrl, { width: 200 });

      document.getElementById("sessionInfo").innerText = "ì„¸ì…˜ ID: " + currentSessionId;

      // ëŒ€ê¸°ì‹¤ í•™ìƒ í‘œì‹œ
      const studentsRef = collection(db, "sessions", currentSessionId, "students");
      onSnapshot(studentsRef, (snapshot) => {
        const list = document.getElementById("students");
        list.innerHTML = "";
        snapshot.forEach(doc => {
          let li = document.createElement("li");
          li.textContent = doc.data().name + (doc.data().clicked ? " âœ…" : "");
          list.appendChild(li);
        });
      });
    }

    async function startSession() {
      if (!currentSessionId) return;
      await updateDoc(doc(db, "sessions", currentSessionId), { status: "started" });
      document.getElementById("status").innerText = "ì„¸ì…˜ ì‹œì‘!";
    }

    window.newSession = newSession;
    window.startSession = startSession;
  </script>
</head>
<body>
  <h2>êµì‚¬ìš© í™”ë©´</h2>
  <button onclick="newSession()">ìƒˆ ì„¸ì…˜ ì‹œì‘</button>
  <div id="sessionInfo"></div>
  <canvas id="qrcode"></canvas>
  <h3>ëŒ€ê¸°ì‹¤</h3>
  <ul id="students"></ul>
  <button onclick="startSession()">ì‹œì‘</button>
  <p id="status"></p>
</body>
</html>
